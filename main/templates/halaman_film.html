{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>Halaman Film</title>
{% endblock meta %}

{% block content %}

<body>
    <h1>HALAMAN FILM</h1>
    <h2>Judul: {{ judul }}</h2>

    <!-- TODO IMPLEMENT -->
    <form id="watchForm" action="{% url 'watch' %}" method="post">
        {% csrf_token %}
        <label for="progress">Progress:</label>
        <input type="range" id="progress" name="progress" min="0" max="100">
        <button id="watchButton" type="button">Tonton</button>
    </form>
    
    <button data-bs-toggle="modal" data-bs-target="#unduhModal">Unduh Tayangan</button>

    <button data-bs-toggle="modal" data-bs-target="#favoritModal">Favorit Tayangan</button>

    <p>Total View: {{ total_view }}</p>
    <p>Rating Rata-Rata: {{ avg_rating }}</p>
    <p>Sinopsis: {{ sinopsis }}</p>
    <p>Durasi Film: {{ durasi_film }} menit</p>
    <p>Tanggal Rilis Film: {{ release_date_film }}</p>
    <p>URL Film: <a href="{{ url_video_film }}">{{ url_video_film }}</a></p>

    <h3>Genre:</h3>
    {% if haveGenres %}
        <ul>
        {% for g in genre %}
            <li>{{ g.0 }}</li>
        {% endfor %}
        </ul>
    {% else %}
        <p>{{ genre }}</p>
    {% endif %}

    <h3>Asal Negara: {{ asal_negara }}</h3>

    <h3>Pemain:</h3>
    {% if haveActors %}
        <ul>
        {% for a in actors %}
            <li>{{ a.0 }}</li>
        {% endfor %}
        </ul>
    {% else %}
        <p>{{ actors }}</p>
    {% endif %}

    <h3>Penulis Skenario:</h3>
    {% if haveWriters %}
        <ul>
        {% for w in writers %}
            <li>{{ w.0 }}</li>
        {% endfor %}
        </ul>
    {% else %}
        <p>{{ writers }}</p>
    {% endif %}

    <h3>Sutradara: {{ sutradara }}</h3>

    <h3>Bagian Ulasan</h3>

    <form action="" method="post">
        {% csrf_token %}
        <textarea name="review_text" placeholder="Input untuk deskripsi ulasan"></textarea>
        <input type="number" name="rating" min="1" max="5" placeholder="rating yang diberikan">
        <button type="submit">Submit</button>
    </form>
    
    <h4>Daftar Ulasan:</h4>
    <ul>
        <li>
            <p>Username: data</p>
            <p>Deskripsi: data</p>
            <p>Rating: data</p>
        </li>
        <li>
            <p>Username: data</p>
            <p>Deskripsi: data</p>
            <p>Rating: data</p>
        </li>
    </ul>

    <div class="modal fade" id="unduhModal" tabindex="-1" role="dialog" aria-labelledby="unduhModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="unduhModalLabel">SUKSES MENAMBAHKAN TAYANGAN KE DAFTAR UNDUHAN
                        </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Selamat! Anda telah berhasil mengunduh [Judul Tayangan] dan akan
                    berlaku hingga [current time + 7 hari]. Cek informasi selengkapnya
                    pada halaman daftar unduhan.
                </div>
                <div class="modal-footer">
                    <a class="btn btn-primary">Daftar Unduhan</a>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="favoritModal" tabindex="-1" role="dialog" aria-labelledby="favoritModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="favoritModalLabel">TAMBAH KE DAFTAR FAVORIT MODAL</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <span>Judul Daftar Favorit: </span>
                    <select id="favoriteDropdown">
                        <option value="">Pilih Daftar Favorit</option>
                        <option value="favorit1">Favorit 1</option>
                        <option value="favorit2">Favorit 2</option>
                        <option value="favorit3">Favorit 3</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <a class="btn btn-success">Tambah</a>
                </div>
            </div>
        </div>
    </div>
    
</body>
<!-- TODO IMPLEMENT -->
<script>
    let watchInterval;
    
    $(document).ready(function(){
        $('#watchButton').click(function(){
            if ($(this).text() === 'Tonton') {
                // Start watching
                $(this).text('Stop');
                const startDateTime = new Date();
                $('#watchForm').append(`<input type="hidden" name="start_date_time" value="${startDateTime.toISOString()}">`);
                watchInterval = setInterval(function() {
                    const progress = $('#progress').val();
                    if (progress < 100) {
                        $('#progress').val(parseInt(progress) + 1);
                    } else {
                        clearInterval(watchInterval);
                    }
                }, 60000);  // Increase progress by 1 every minute
            } else {
                // Stop watching
                $(this).text('Tonton');
                const endDateTime = new Date();
                $('#watchForm').append(`<input type="hidden" name="end_date_time" value="${endDateTime.toISOString()}">`);
                clearInterval(watchInterval);
                // Submit the form
                $.ajax({
                    type: 'POST',
                    url: $('#watchForm').attr('action'),
                    data: $('#watchForm').serialize(),
                    success: function(){
                        // Do something when the request is successful
                    }
                });
            }
        });
    });
</script>

{% endblock content %}